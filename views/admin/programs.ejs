<%- include('../partials/header') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<main class="max-w-7xl mx-auto p-8 md:p-12">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
        
        <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 h-fit sticky top-28">
            <h2 class="text-xl font-black text-slate-800 mb-6 flex items-center gap-2">
                <span class="w-2 h-6 bg-indigo-600 rounded-full"></span> á”á„áŸ’á€á¾áá€á˜áŸ’á˜áœá·á’á¸ááŸ’á˜á¸
            </h2>
            <form action="/admin/programs/create" method="POST" class="space-y-4">
                <input type="text" name="name" placeholder="áˆáŸ’á˜áŸ„áŸ‡á€á˜áŸ’á˜áœá·á’á¸ (á§. áŸá·á€áŸ’áá¶áŸá¶á›á¶ IT)" required 
                       class="w-full px-5 py-4 border rounded-2xl bg-slate-50 outline-none focus:ring-4 focus:ring-indigo-50 focus:border-indigo-400 transition-all font-bold">
                
                <input type="date" name="date" required 
                       class="w-full px-5 py-4 border rounded-2xl bg-slate-50 outline-none font-bold text-slate-600">
                
                <select name="session" class="w-full px-5 py-4 border rounded-2xl bg-slate-50 font-bold text-slate-600 appearance-none">
                    <option value="Morning">Morning (á–áŸ’ášá¹á€)</option>
                    <option value="Evening">Evening (á›áŸ’á„á¶á…)</option>
                </select>

                <div class="grid grid-cols-2 gap-4">
                    <input type="time" name="startTime" class="px-5 py-4 border rounded-2xl bg-slate-50 text-sm font-bold">
                    <input type="time" name="endTime" class="px-5 py-4 border rounded-2xl bg-slate-50 text-sm font-bold">
                </div>

                <textarea name="description" placeholder="á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·á..." 
                          class="w-full px-5 py-4 border rounded-2xl bg-slate-50 h-28 resize-none text-sm font-medium outline-none"></textarea>
                
                <button type="submit" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-95">
                    ášá€áŸ’áŸá¶á‘á»á€á€á˜áŸ’á˜áœá·á’á¸
                </button>
            </form>
        </div>

        <div class="lg:col-span-2 space-y-8">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 min-h-[500px]">
                <h2 class="text-xl font-black text-slate-800 mb-8 flex items-center justify-between">
                    á”á‰áŸ’á‡á¸á€á˜áŸ’á˜áœá·á’á¸á‘á¶áŸ†á„á¢áŸáŸ‹
                    <span class="text-xs bg-slate-100 px-3 py-1 rounded-full text-slate-400 font-bold uppercase"><%= programs.length %> Programs</span>
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <% programs.forEach(program => { %>
                        <div class="p-6 border border-slate-100 rounded-[2rem] hover:shadow-lg hover:border-indigo-100 transition-all group relative overflow-hidden bg-slate-50/30">
                            <h3 class="font-black text-slate-800 text-lg mb-2"><%= program.name %></h3>
                            <div class="space-y-1 mb-6">
                                <div class="flex items-center gap-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                    <span>ğŸ“… <%= new Date(program.date).toLocaleDateString() %></span>
                                    <span>â€¢</span>
                                    <span><%= program.session %></span>
                                </div>
                                <p class="text-[10px] font-bold text-indigo-500">â° <%= program.startTime %> - <%= program.endTime %></p>
                            </div>

                            <button onclick="openScanner('<%= program._id %>', '<%= program.name %>')" 
                                    class="w-full py-3 bg-emerald-500 text-white text-[10px] font-black rounded-xl shadow-lg shadow-emerald-100 hover:bg-emerald-600 transition-all flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v-3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                                SCAN ATTENDANCE
                            </button>
                        </div>
                    <% }) %>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    let html5QrCode;

    async function openScanner(programId, programName) {
        console.log("ğŸš€ Scanner Initialized for Program:", programId);

        Swal.fire({
            title: 'á€áŸ†á–á»á„áŸáŸ’á€áŸ‚á“áœááŸ’áá˜á¶á“áŸ–',
            html: `
                <p class="text-xs font-bold text-indigo-600 mb-4 uppercase tracking-widest">${programName}</p>
                <div id="reader" class="rounded-2xl overflow-hidden border-4 border-slate-100 shadow-inner bg-black aspect-square"></div>
                <p class="text-[10px] text-slate-400 mt-4 font-bold">áŸá¼á˜á”á„áŸ’á á¶á‰ QR Code ášá”áŸáŸ‹áŸá·áŸáŸ’áŸá±áŸ’á™á…áŸ†á€á¶á˜áŸášáŸ‰á¶</p>
            `,
            showConfirmButton: false,
            showCloseButton: true,
            width: '450px',
            customClass: { popup: 'rounded-[2.5rem]' },
            didOpen: () => {
                // áŸ¡. á…á¶á”áŸ‹á•áŸ’áŠá¾á˜á€á¶á˜áŸášáŸ‰á¶á–á·áá”áŸ’ášá¶á€áŠ
                html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start(
                    { facingMode: "environment" }, 
                    { fps: 15, qrbox: { width: 250, height: 250 } },
                    (studentId) => {
                        // áŸ¢. á“áŸ…á–áŸá›áŸáŸ’á€áŸ‚á“á‡á¶á”áŸ‹ (á”á¶á“ ID áŸá·áŸáŸ’áŸ) á”á¶á‰áŸ‹á‘áŸ… Server
                        submitAttendance(studentId, programId);
                        html5QrCode.stop(); // á”á·á‘á€á¶á˜áŸášáŸ‰á¶áŸá·á“áŠá¾á˜áŸ’á”á¸á€á»áŸ†á±áŸ’á™ Error á‡á¶á“áŸ‹á‚áŸ’á“á¶
                        Swal.close();
                    }
                ).catch(err => {
                    console.error("âŒ Camera Blocked or Error:", err);
                    Swal.showValidationMessage(`á€á¶á˜áŸášáŸ‰á¶á˜á·á“áŠá¾ášá‘áŸá”á„! á”á„ááŸ’ášá¼áœá”áŸ’ášá¾ HTTPS á¬ localhost!`);
                });
            },
            willClose: () => {
                if(html5QrCode) html5QrCode.stop().catch(e => console.log("Scanner stopped."));
            }
        });
    }

    function submitAttendance(studentId, programId) {
        $.ajax({
            type: 'POST',
            url: '/api/check-in',
            data: { studentId, programId },
            success: function(res) {
                Swal.fire({
                    title: 'á‡áŸ„á‚á‡áŸá™! ğŸ‰',
                    text: res.message,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false,
                    customClass: { popup: 'rounded-[2rem]' }
                });
            },
            error: function(err) {
                Swal.fire({
                    title: 'á”ášá¶á‡áŸá™!',
                    text: err.responseJSON ? err.responseJSON.message : 'á˜á¶á“á”á‰áŸ’á á¶á”á…áŸ’á…áŸá€á‘áŸáŸ!',
                    icon: 'error',
                    confirmButtonColor: '#ef4444'
                });
            }
        });
    }
</script>

<%- include('../partials/footer') %>