<!DOCTYPE html>
<html lang="km">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡á…á¼á›ášá½á˜ (Registration)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        font-family: "Kantumruy Pro", sans-serif;
        background-color: #f8fafc;
      }

      /* --- Select2 Custom Styling (Responsive) --- */
      .select2-container--default .select2-selection--single {
        border-radius: 0.75rem; /* rounded-xl */
        border: 1.5px solid #e2e8f0;
        background-color: #f8fafc;
        padding-left: 8px;
        display: flex;
        align-items: center;
        transition: all 0.2s ease-in-out;
      }
      
      /* Mobile Height */
      .select2-container .select2-selection--single {
        height: 50px; 
      }
      
      /* Desktop Height */
      @media (min-width: 768px) {
        .select2-container .select2-selection--single {
            height: 58px;
            border-radius: 1rem; /* rounded-2xl */
            padding-left: 12px;
        }
      }

      .select2-container--default .select2-selection--single:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
      }
      .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #1e293b;
        font-weight: 700;
        font-size: 0.75rem; /* Text small on mobile */
        padding-left: 30px;
      }
      @media (min-width: 768px) {
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            font-size: 0.875rem; /* Normal on desktop */
        }
      }

      .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 100%;
        right: 12px;
      }
      .select2-dropdown {
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        z-index: 9999;
      }
      .select2-search__field {
        border-radius: 0.5rem !important;
        padding: 8px !important;
        border: 1px solid #cbd5e1 !important;
      }
    </style>
  </head>

  <body class="p-3 md:p-12 relative overflow-x-hidden min-h-screen flex items-center justify-center">
    <div class="fixed top-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-100/40 rounded-full blur-[80px] -z-10"></div>
    <div class="fixed bottom-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-100/40 rounded-full blur-[80px] -z-10"></div>

    <div class="max-w-4xl mx-auto w-full bg-white/95 backdrop-blur-2xl rounded-3xl md:rounded-[3rem] shadow-[0_20px_50px_-12px_rgba(0,0,0,0.1)] border border-white/60 overflow-hidden">
      
      <div class="bg-gradient-to-br from-blue-600 to-indigo-800 p-8 md:p-16 text-center text-white relative">
        <div class="absolute inset-0 opacity-10 pointer-events-none">
          <svg width="100%" height="100%">
            <pattern id="grid" width="30" height="30" patternUnits="userSpaceOnUse">
              <path d="M 30 0 L 0 0 0 30" fill="none" stroke="white" stroke-width="0.5" />
            </pattern>
            <rect width="100%" height="100%" fill="url(#grid)" />
          </svg>
        </div>
        <div class="relative z-10">
          <h2 class="text-2xl md:text-5xl font-black mb-2 md:mb-3 tracking-tight">á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡á…á¼á›ášá½á˜</h2>
          <p class="text-blue-50 text-xs md:text-lg font-medium opacity-90 italic">
            áŸá¼á˜á”áŸ†á–áŸá‰á–áŸááŸŒá˜á¶á“á–á·áášá”áŸáŸ‹á”áŸ’á¢á¼á“ áŠá¾á˜áŸ’á”á¸á”á‰áŸ’á‡á¶á€áŸ‹áœááŸ’áá˜á¶á“
          </p>
        </div>
      </div>

      <form action="/api/register" method="POST" class="p-5 md:p-16 space-y-8 md:space-y-12">
        
        <div class="space-y-6 md:space-y-8">
          <div class="flex items-center space-x-3 md:space-x-4 border-b border-slate-100 pb-3 md:pb-4">
            <div class="bg-blue-50 p-2 md:p-3 rounded-xl md:rounded-2xl text-blue-600">
              <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
            </div>
            <h3 class="text-lg md:text-xl font-black text-slate-800">á–áŸááŸŒá˜á¶á“á•áŸ’á‘á¶á›áŸ‹ááŸ’á›á½á“</h3>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-5 md:gap-8">
            <div class="md:col-span-2 group">
              <label class="block text-[10px] md:text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1.5 px-1">á˜á€á–á¸áœá·á‘áŸ’á™á¶á›áŸá™ <span class="text-rose-500">*</span></label>
              <div class="relative school-select-container">
                <span class="absolute left-3 md:left-4 top-[14px] md:top-[18px] z-10 text-slate-300 group-focus-within:text-indigo-500 transition-colors">
                  <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path></svg>
                </span>
                <select id="schoolSelect" name="high_school" required class="w-full">
                  <option value="" disabled selected>áŸáŸ’áœáŸ‚á„ášá€áˆáŸ’á˜áŸ„áŸ‡áœá·á‘áŸ’á™á¶á›áŸá™ášá”áŸáŸ‹á”áŸ’á¢á¼á“...</option>
                  <% 
                    let currentProvince = "";
                    if (typeof schools !== 'undefined' && schools.length > 0) {
                        schools.forEach(school => {
                            if (school.province !== currentProvince) {
                                if (currentProvince !== "") { %> </optgroup> <% }
                                currentProvince = school.province;
                  %>
                                <optgroup label="<%= currentProvince %>">
                            <% } %>
                            <option value="<%= school.name %>"><%= school.name %></option>
                  <%    }); 
                    } else { %>
                        <option disabled>á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</option>
                  <% } %>
                  <% if (currentProvince !== "") { %> </optgroup> <% } %>
                </select>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-5 md:gap-8">
            <div class="group">
              <label class="block text-[10px] md:text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1.5 px-1">áˆáŸ’á˜áŸ„áŸ‡á‡á¶á—á¶áŸá¶ááŸ’á˜áŸ‚áš <span class="text-rose-500">*</span></label>
              <div class="relative">
                <span class="absolute left-3 md:left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-500 transition-colors">
                  <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </span>
                <input type="text" name="name_kh" placeholder="á§. áŸá»á áŸáŸ†áá¶á„" required class="w-full pl-10 md:pl-12 pr-4 py-3 md:py-4 border border-slate-200 rounded-xl md:rounded-2xl bg-slate-50/50 outline-none focus:ring-4 focus:ring-blue-50 focus:border-blue-400 transition-all font-bold text-slate-700 text-sm md:text-base" />
              </div>
            </div>
            <div class="group">
              <label class="block text-[10px] md:text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1.5 px-1">áˆáŸ’á˜áŸ„áŸ‡á‡á¶á¢á„áŸ‹á‚áŸ’á›áŸáŸ<span class="text-rose-500">(Optional)</span></label>
              <div class="relative">
                <span class="absolute left-3 md:left-4 top-1/2 -translate-y-1/2 text-slate-300 group-focus-within:text-blue-500 transition-colors">
                  <svg class="w-4 h-4 md:w-5 md:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </span>
                <input type="text" name="name_en" placeholder="á§. SOK SOMNANG" class="w-full pl-10 md:pl-12 pr-4 py-3 md:py-4 border border-slate-200 rounded-xl md:rounded-2xl bg-slate-50/50 outline-none focus:ring-4 focus:ring-blue-50 focus:border-blue-400 transition-all font-bold text-slate-700 text-sm md:text-base" />
              </div>
            </div>
            <div>
              <label class="block text-[10px] md:text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1.5 px-1">á—áŸá‘ <span class="text-rose-500">*</span></label>
              <select name="gender" required class="w-full px-4 md:px-5 py-3 md:py-4 border border-slate-200 rounded-xl md:rounded-2xl bg-slate-50/50 outline-none focus:border-blue-400 font-bold text-slate-700 appearance-none text-sm md:text-base">
                <option value="" disabled selected>á‡áŸ’ášá¾áŸášá¾áŸá—áŸá‘</option>
                <option value="á”áŸ’ášá»áŸ">á”áŸ’ášá»áŸ / Male</option>
                <option value="áŸáŸ’ášá¸">áŸáŸ’ášá¸ / Female</option>
              </select>
            </div>
            <div class="group">
              <label class="block text-[10px] md:text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1.5 px-1">á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘ <span class="text-rose-500">*</span></label>
              <input type="tel" name="phone" placeholder="012 345 678" required class="w-full px-4 md:px-5 py-3 md:py-4 border border-slate-200 rounded-xl md:rounded-2xl bg-slate-50/50 outline-none focus:ring-4 focus:ring-blue-50 focus:border-blue-400 transition-all font-bold text-slate-700 text-sm md:text-base" />
            </div>
          </div>
        </div>

        <div class="space-y-6 md:space-y-8">
          <div class="flex items-center space-x-3 md:space-x-4 border-b border-slate-100 pb-3 md:pb-4">
            <div class="bg-indigo-50 p-2 md:p-3 rounded-xl md:rounded-2xl text-indigo-600">
              <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
              </svg>
            </div>
            <h3 class="text-lg md:text-xl font-black text-slate-800">á–áŸááŸŒá˜á¶á“áŸá·á€áŸ’áŸá¶ á“á·á„á‘á¸á›áŸ†á“áŸ…</h3>
          </div>

          <div class="md:col-span-2 group">
            <div class="block text-[10px] md:text-[11px] font-black text-slate-400 uppercase tracking-widest mb-1.5 px-1">á¢á¶áŸá™áŠáŸ’á‹á¶á“á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“ <span class="text-rose-500">(Optional)</span></div>
            <textarea name="address" rows="3" placeholder="áœá¶á™á”á‰áŸ’á…á¼á›á¢á¶áŸá™áŠáŸ’á‹á¶á“á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“ášá”áŸáŸ‹á¢áŸ’á“á€..." class="w-full px-4 md:px-6 py-3 md:py-4 border border-slate-200 rounded-xl md:rounded-2xl bg-slate-50/50 outline-none focus:ring-4 focus:ring-indigo-50 focus:border-indigo-400 transition-all resize-none font-medium text-sm md:text-base"></textarea>
          </div>
        </div>

        <div class="pt-4 md:pt-6">
          <button type="submit" class="w-full h-12 md:h-16 bg-gradient-to-r from-blue-600 to-indigo-700 text-white font-black rounded-xl md:rounded-2xl shadow-xl shadow-blue-200 hover:shadow-blue-300 hover:-translate-y-1 transition-all text-sm md:text-lg flex items-center justify-center space-x-2 md:space-x-3 active:scale-[0.98]">
            <span>á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡ & á…á¼á› Telegram</span>
            <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
          </button>
        </div>
      </form>
    </div>

    <script>
      $(document).ready(function () {
        $("#schoolSelect").select2({
          placeholder: "áŸáŸ’áœáŸ‚á„ášá€áˆáŸ’á˜áŸ„áŸ‡áœá·á‘áŸ’á™á¶á›áŸá™ášá”áŸáŸ‹á”áŸ’á¢á¼á“...",
          allowClear: true,
          width: "100%",
          language: { noResults: () => "ášá€á˜á·á“áƒá¾á‰áŸá¶á›á¶á“áŸáŸ‡á‘áŸá”á„!" },
        });

        // ğŸ”¥ Dynamic Link
        const schoolTelegramLinks = <%- (typeof schoolLinkMap !== 'undefined') ? JSON.stringify(schoolLinkMap) : '{}' %>; 
        const mainTelegramLink = "https://t.me/+YOaeX_H1LSoxZDFl";

        $("form").on("submit", function (e) {
          e.preventDefault();
          
          const selectedSchool = $("#schoolSelect").val();
          const specificSchoolLink = schoolTelegramLinks[selectedSchool];

          Swal.fire({
            title: "á€áŸ†á–á»á„á–á·á“á·ááŸ’á™á–áŸááŸŒá˜á¶á“...",
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); },
          });

          $.ajax({
            type: "POST",
            url: "/api/register",
            data: $(this).serialize(),
            success: function (res) {
              Swal.fire({
                title: "á‡áŸ„á‚á‡áŸá™! ğŸ‰",
                html: `
                    <div class="text-left">
                        <p class="mb-4 text-sm text-gray-600">á€á¶ášá…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡á”á¶á“á‡áŸ„á‚á‡áŸá™! áŸá¼á˜á…á»á…á”áŸŠá¼áá»á„áá¶á„á€áŸ’ášáŸ„á˜áŠá¾á˜áŸ’á”á¸á…á¼á›ášá½á˜á€áŸ’ášá»á˜ TelegramáŸ”</p>
                        <div class="space-y-3 bg-slate-50 p-4 rounded-xl border border-slate-100">
                            <div class="flex items-center gap-2 text-emerald-600 font-bold">
                                <span>1. á€áŸ’ášá»á˜${selectedSchool}</span>
                                <span class="text-[10px] bg-emerald-100 px-2 py-0.5 rounded-full">áŸá¶á›á¶</span>
                            </div>
                            <div class="flex items-center gap-2 text-indigo-600 font-bold">
                                <span>2. á€áŸ’ášá»á˜á‘á¼á‘áŸ… (General Group)</span>
                                <span class="text-[10px] bg-indigo-100 px-2 py-0.5 rounded-full">á…á¶áŸ†á”á¶á…áŸ‹</span>
                            </div>
                        </div>
                    </div>
                `,
                icon: "success",
                showConfirmButton: true,
                confirmButtonText: "ğŸš€ á…á»á…á‘á¸á“áŸáŸ‡áŠá¾á˜áŸ’á”á¸á…á¼á›á€áŸ’ášá»á˜ (Join Now)",
                confirmButtonColor: "#3b82f6",
                allowOutsideClick: false,
                customClass: { popup: "rounded-[2rem]" },
              }).then((result) => {
                if (result.isConfirmed) {
                    
                    // ğŸ”¥ LOGIC: á”á„áŸ’á á¶á‰ Reminder Alert á—áŸ’á›á¶á˜áŸ— (á˜á»á“á“á¹á„á”á¾á€ Link)
                    Swal.fire({
                        title: "âš ï¸ áŸá¼á˜á…áŸ†áá¶áŸ†! (Attention)",
                        html: `
                            <div class="text-left text-sm text-gray-600">
                                <p class="mb-3">á”á“áŸ’á‘á¶á”áŸ‹á–á¸á…á»á…á”áŸŠá¼áá»á„á“áŸáŸ‡ á”áŸ’á¢á¼á“ááŸ’ášá¼áœá…á¼á› <b>á€áŸ’ášá»á˜áŸá¶á›á¶</b> á‡á¶á˜á»á“áŸá·á“áŸ”</p>
                                <p class="font-bold text-red-500 mb-2">á”á“áŸ’á‘á¶á”áŸ‹á˜á€ áŸá¼á˜ááŸ’ášá¡á”áŸ‹á˜á€á€á¶á“áŸ‹á‘áŸ†á–áŸášá“áŸáŸ‡áœá·á‰!</p>
                                <p>áŠá¾á˜áŸ’á”á¸á…á¼á›ášá½á˜ <b>á€áŸ’ášá»á˜á‘á¼á‘áŸ…</b> á˜á½á™á‘áŸ€ááŠáŸ‚á›áŸáŸ†áá¶á“áŸ‹áá¶áŸáŸ‹áŸ”</p>
                            </div>
                        `,
                        icon: "warning",
                        showConfirmButton: true,
                        confirmButtonText: "ğŸ‘Œ á™á›áŸ‹á–áŸ’ášá˜ & á…á¼á›á€áŸ’ášá»á˜áŸá¶á›á¶",
                        confirmButtonColor: "#3b82f6",
                        allowOutsideClick: false,
                        customClass: { popup: "rounded-[2rem]" }
                    }).then((resStep1) => {
                        if (resStep1.isConfirmed) {
                            // 1. á”á¾á€ Link á€áŸ’ášá»á˜áŸá¶á›á¶ (Tab ááŸ’á˜á¸)
                            if (specificSchoolLink) {
                                window.open(specificSchoolLink, '_blank');
                            }

                            // 2. á”á„áŸ’á á¶á‰ Alert á‘á¸ áŸ¢ (ášá„áŸ‹á…á¶áŸ†á€á¶ášááŸ’ášá¡á”áŸ‹á˜á€áœá·á‰)
                            setTimeout(() => {
                                Swal.fire({
                                    title: "á‡áŸ†á á¶á“á…á»á„á€áŸ’ášáŸ„á™ (Final Step)",
                                    html: `
                                        <div class="text-left text-sm text-gray-600">
                                            <p class="mb-2">áá¾á”áŸ’á¢á¼á“á”á¶á“á…á¼á› <b>á€áŸ’ášá»á˜áŸá¶á›á¶</b> ášá½á…ášá¶á›áŸ‹á á¾á™á˜áŸ‚á“á‘áŸ?</p>
                                            <p>áŸá¼á˜á…á»á…á”áŸŠá¼áá»á„áá¶á„á€áŸ’ášáŸ„á˜áŠá¾á˜áŸ’á”á¸á…á¼á› <b>á€áŸ’ášá»á˜á‘á¼á‘áŸ… (General Group)</b>áŸ”</p>
                                        </div>
                                    `,
                                    icon: "question",
                                    showConfirmButton: true,
                                    confirmButtonText: "ğŸš€ á…á¼á›ášá½á˜á€áŸ’ášá»á˜á‘á¼á‘áŸ… (Join General Group)",
                                    confirmButtonColor: "#10b981", 
                                    allowOutsideClick: false,
                                    customClass: { popup: "rounded-[2rem]" }
                                }).then((resStep2) => {
                                    if (resStep2.isConfirmed) {
                                        // 3. á”á¾á€ Link á€áŸ’ášá»á˜á‘á¼á‘áŸ…
                                        window.location.assign(mainTelegramLink);
                                    }
                                });
                            }, 1000); 
                        }
                    });
                }
              });
            },
            error: function (err) {
              Swal.fire({
                title: "á˜á¶á“á”á‰áŸ’á á¶!",
                text: err.responseJSON ? err.responseJSON.message : "á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘á“áŸáŸ‡á”áŸ’ášá áŸ‚á›á‡á¶á˜á¶á“ášá½á…á á¾á™á”á„!",
                icon: "error",
                confirmButtonColor: "#3b82f6",
                customClass: { popup: "rounded-[2rem]" },
              });
            },
          });
        });
      });
    </script>
  </body>
</html>