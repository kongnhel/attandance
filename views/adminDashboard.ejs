<%- include('partials/header') %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<main class="max-w-7xl mx-auto p-4 md:p-10 pb-24">
    <% 
        // --- üìä ·ûï·üí·ûì·üÇ·ûÄ·ûö·üÄ·ûî·ûÖ·üÜ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô ---
        let totalStudents = students.length;
        
        const provinceMap = {};
        const schoolMap = {};
        const groupedStudents = {}; 

        students.forEach(s => {
            provinceMap[s.province] = (provinceMap[s.province] || 0) + 1;
            schoolMap[s.high_school] = (schoolMap[s.high_school] || 0) + 1;

            const schoolName = s.high_school || "·ûï·üí·ûü·üÅ·ûÑ·üó";
            if (!groupedStudents[schoolName]) {
                groupedStudents[schoolName] = [];
            }
            groupedStudents[schoolName].push(s);
        });

        const schoolNames = Object.keys(groupedStudents).sort();
        const provinceLabels = Object.keys(provinceMap);
        const provinceValues = Object.values(provinceMap);
        
        const sortedSchools = Object.entries(schoolMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
        const schoolLabels = sortedSchools.map(item => item[0]);
        const schoolValues = sortedSchools.map(item => item[1]);

        let totalSchools = Object.keys(schoolMap).length;
        let totalProvinces = Object.keys(provinceMap).length;
    %>
    
    <div style="display: none;">
        <table id="studentTable">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Name KH</th>
                    <th>Name EN</th>
                    <th>Gender</th>
                    <th>Phone</th>
                    <th>High School</th>
                    <th>Province</th>
                </tr>
            </thead>
            <tbody>
                <% students.forEach((s, index) => { %>
                    <tr>
                        <td><%= index + 1 %></td>
                        <td><%= s.name_kh || "" %></td>
                        <td><%= s.name_en || "" %></td>
                        <td><%= s.gender || "" %></td>
                        <td><%= s.phone || "" %></td>
                        <td><%= s.high_school || "" %></td>
                        <td><%= s.province || "" %></td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
        <div>
            <h1 class="text-2xl md:text-3xl font-extrabold text-slate-800 tracking-tight mb-1">
                <span class="text-indigo-600">Student</span> Data Center
            </h1>
            <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase tracking-widest">
                ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûü·û∑·ûü·üí·ûü ·ûì·û∑·ûÑ·ûü·üí·ûê·û∑·ûè·û∑·ûú·û∑·ûë·üí·ûô·û∂·ûõ·üê·ûô
            </p>
        </div>
        
        <div class="flex w-full md:w-auto items-center space-x-3">
            <div class="relative flex-grow md:w-72 group">
                <input type="text" id="searchInput" onkeyup="searchFunction()" placeholder="·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ·ûà·üí·ûò·üÑ·üá, ·ûü·û∂·ûõ·û∂..." 
                    class="w-full pl-11 pr-4 py-3 bg-white border border-slate-200 rounded-2xl outline-none text-sm font-bold text-slate-600 focus:ring-4 focus:ring-indigo-50 focus:border-indigo-500 transition-all shadow-sm">
                <svg class="w-5 h-5 absolute left-3.5 top-3 text-slate-400 group-focus-within:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            
            <button onclick="exportToExcel()" class="bg-emerald-500 hover:bg-emerald-600 text-white p-3 rounded-2xl transition-all shadow-lg shadow-emerald-100 active:scale-95 group flex-shrink-0" title="Export Excel">
                <svg class="w-5 h-5 group-hover:animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6 mb-10">
        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden">
            <div class="absolute right-0 top-0 w-24 h-24 bg-indigo-50 rounded-full -mr-8 -mt-8 opacity-50"></div>
            <p class="text-[10px] font-black text-indigo-400 uppercase mb-1 tracking-[0.2em] relative z-10">Total Students</p>
            <h3 class="text-3xl md:text-4xl font-black text-slate-800 relative z-10"><%= totalStudents %></h3>
        </div>
        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden">
            <div class="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-full -mr-8 -mt-8 opacity-50"></div>
            <p class="text-[10px] font-black text-blue-400 uppercase mb-1 tracking-[0.2em] relative z-10">Total Schools</p>
            <h3 class="text-3xl md:text-4xl font-black text-slate-800 relative z-10"><%= totalSchools %></h3>
        </div>
        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden">
            <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-50 rounded-full -mr-8 -mt-8 opacity-50"></div>
            <p class="text-[10px] font-black text-emerald-400 uppercase mb-1 tracking-[0.2em] relative z-10">Provinces</p>
            <h3 class="text-3xl md:text-4xl font-black text-slate-800 relative z-10"><%= totalProvinces %></h3>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8 mb-12">
        <div class="bg-white p-6 md:p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
            <h3 class="text-xs md:text-sm font-bold text-slate-700 mb-6 flex items-center gap-2">
                <span class="w-3 h-3 bg-blue-500 rounded-full"></span> 
                ·ûÄ·û∂·ûö·ûî·üÇ·ûÑ·ûÖ·üÇ·ûÄ·ûè·û∂·ûò·ûÅ·üÅ·ûè·üí·ûè
            </h3>
            <div class="h-[250px] md:h-[300px] relative"><canvas id="provinceChart"></canvas></div>
        </div>
        <div class="bg-white p-6 md:p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
            <h3 class="text-xs md:text-sm font-bold text-slate-700 mb-6 flex items-center gap-2">
                <span class="w-3 h-3 bg-indigo-500 rounded-full"></span> 
                ·ûü·û∂·ûõ·û∂·ûä·üÇ·ûõ·ûò·û∂·ûì·ûü·û∑·ûü·üí·ûü·ûÖ·üí·ûö·ûæ·ûì·ûá·û∂·ûÑ·ûÇ·üÅ
            </h3>
            <div class="h-[250px] md:h-[300px] relative"><canvas id="schoolChart"></canvas></div>
        </div>
    </div>

    <div class="space-y-8" id="schoolContainer">
        <% if (schoolNames.length > 0) { %>
            <% schoolNames.forEach((school, index) => { %>
                
                <div class="school-block bg-white rounded-[2rem] md:rounded-[2.5rem] border border-slate-100 shadow-sm overflow-hidden animate-fade-in" style="animation-delay: <%= index * 50 %>ms">
                    
                    <div class="px-5 py-5 md:px-8 md:py-6 bg-slate-50/80 border-b border-slate-100 flex justify-between items-center">
                        <div class="flex items-center gap-3 md:gap-4">
                            <div class="w-10 h-10 md:w-12 md:h-12 rounded-2xl bg-white border border-slate-100 shadow-sm flex items-center justify-center text-lg md:text-xl">üè´</div>
                            <div>
                                <h2 class="text-sm md:text-lg font-black text-slate-800 school-title line-clamp-1"><%= school %></h2>
                                <p class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-wide">
                                    <%= groupedStudents[school].length %> Students
                                </p>
                            </div>
                        </div>
                        <span class="bg-indigo-50 text-indigo-600 px-3 py-1 md:px-4 md:py-1.5 rounded-full text-[9px] md:text-[10px] font-black uppercase tracking-widest border border-indigo-100 whitespace-nowrap">
                            #<%= index + 1 %>
                        </span>
                    </div>

                    <div class="overflow-x-auto w-full">
                        <table class="w-full text-left border-collapse whitespace-nowrap"> <thead class="bg-white">
                                <tr class="text-[10px] font-black text-slate-400 uppercase tracking-[0.1em] border-b border-slate-50">
                                    <th class="px-5 py-3 md:px-8 md:py-4">Student Name</th>
                                    <th class="px-5 py-3 md:px-6 md:py-4">Gender & Phone</th>
                                    <th class="px-5 py-3 md:px-6 md:py-4">Province</th>
                                    <th class="px-5 py-3 md:px-8 md:py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-50">
                                <% groupedStudents[school].forEach(student => { %>
                                    <tr class="hover:bg-indigo-50/30 transition-colors group student-row">
                                        <td class="px-5 py-3 md:px-8 md:py-4">
                                            <div class="flex items-center gap-3">
                                                <div class="w-8 h-8 md:w-9 md:h-9 rounded-2xl bg-slate-100 flex items-center justify-center text-[10px] md:text-xs font-black text-slate-500 group-hover:bg-indigo-500 group-hover:text-white transition-colors">
                                                    <%= (student.name_en && student.name_en.length > 0) ? student.name_en.charAt(0).toUpperCase() : '?' %>
                                                </div>
                                                <div>
                                                    <div class="font-bold text-slate-700 text-xs md:text-sm search-text"><%= student.name_kh %></div>
                                                    <div class="text-[9px] md:text-[10px] text-slate-400 font-bold uppercase search-text"><%= student.name_en || "" %></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-5 py-3 md:px-6 md:py-4">
                                            <div class="flex flex-col">
                                                <span class="text-[10px] md:text-xs font-bold text-slate-600 font-mono"><%= student.phone %></span>
                                                <span class="text-[9px] md:text-[10px] text-slate-400 font-bold"><%= student.gender %></span>
                                            </div>
                                        </td>
                                        <td class="px-5 py-3 md:px-6 md:py-4">
                                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg bg-slate-50 text-slate-500 text-[9px] md:text-[10px] font-bold uppercase border border-slate-100">
                                                üìç <%= student.province %>
                                            </span>
                                        </td>
                                        <td class="px-5 py-3 md:px-8 md:py-4 text-right">
                                            <button onclick="confirmDelete('<%= student._id %>', '<%= student.name_kh %>')" class="p-2 text-rose-400 hover:bg-rose-500 hover:text-white rounded-xl transition-all shadow-sm" title="Delete">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                            </button>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                </div>

            <% }) %>
        <% } else { %>
            <div class="text-center py-20 bg-white rounded-[2.5rem] border-2 border-dashed border-slate-200">
                <p class="text-slate-400 font-bold">·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûü·û∑·ûü·üí·ûü·ûë·üÅ·ûî·ûÑ!</p>
            </div>
        <% } %>
    </div>

</main>

<script>
    // --- üóëÔ∏è ·ûò·ûª·ûÅ·ûÑ·û∂·ûö Delete ---
    async function confirmDelete(studentId, studentName) {
        const result = await Swal.fire({
            title: '·ûõ·ûª·ûî·ûü·û∑·ûü·üí·ûü?',
            text: `·ûè·ûæ·ûî·ûÑ·ûÖ·ûÑ·üã·ûõ·ûª·ûî "${studentName}" ·ûÖ·üÅ·ûâ·ûò·üÇ·ûì·ûë·üÅ?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f43f5e',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: 'Yes, Delete',
            customClass: { popup: 'rounded-[2rem]' }
        });

        if (result.isConfirmed) {
            try {
                const response = await fetch(`/admin/delete-student/${studentId}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    Swal.fire({ title: '·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã!', icon: 'success', timer: 1000, showConfirmButton: false }).then(() => location.reload());
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Server Error', 'error');
            }
        }
    }

    // --- üîç ·ûò·ûª·ûÅ·ûÑ·û∂·ûö Search ---
    function searchFunction() {
        let input = document.getElementById("searchInput").value.toUpperCase();
        let blocks = document.querySelectorAll(".school-block");
        
        blocks.forEach(block => {
            let rows = block.querySelectorAll(".student-row");
            let hasVisibleRow = false;
            rows.forEach(row => {
                let text = row.querySelector(".search-text")?.innerText.toUpperCase() || "";
                if (text.includes(input)) {
                    row.style.display = "";
                    hasVisibleRow = true;
                } else {
                    row.style.display = "none";
                }
            });
            block.style.display = hasVisibleRow ? "" : "none";
        });
    }

    // --- üì• Export Excel (Old Logic) ---
    function exportToExcel() {
        let table = document.getElementById("studentTable"); 
        let wb = XLSX.utils.table_to_book(table, { sheet: "Students" });
        XLSX.writeFile(wb, "Student_Data_List.xlsx");
    }

    // --- üìä Chart Logic ---
    Chart.defaults.font.family = "'Kantumruy Pro', sans-serif";
    new Chart(document.getElementById('provinceChart'), {
        type: 'doughnut',
        data: {
            labels: <%- JSON.stringify(provinceLabels) %>,
            datasets: [{
                data: <%- JSON.stringify(provinceValues) %>,
                backgroundColor: ['#6366F1', '#3B82F6', '#818CF8', '#A5B4FC', '#C7D2FE'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } } }
    });

    new Chart(document.getElementById('schoolChart'), {
        type: 'bar',
        data: {
            labels: <%- JSON.stringify(schoolLabels) %>,
            datasets: [{ label: 'Students', data: <%- JSON.stringify(schoolValues) %>, backgroundColor: '#4F46E5', borderRadius: 8, barThickness: 20 }]
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
    });
</script>

<style>
    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
</style>

<%- include('partials/footer') %>