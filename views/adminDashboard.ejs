<%- include('partials/header') %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<main class="max-w-7xl mx-auto p-6 md:p-10">
    <% 
        // --- កូដគណនាស្ថិតិ និង Grouping (Evolution Logic) ---
        let total = students.length;
        let checkedIn = students.filter(s => checkedInIds.includes(s._id.toString())).length;
        let absent = total - checkedIn;
        let rate = total > 0 ? Math.round((checkedIn / total) * 100) : 0;

        const provinceMap = {};
        const schoolMap = {};

        students.forEach(s => {
            provinceMap[s.province] = (provinceMap[s.province] || 0) + 1;
            schoolMap[s.high_school] = (schoolMap[s.high_school] || 0) + 1;
        });

        const provinceLabels = Object.keys(provinceMap);
        const provinceValues = Object.values(provinceMap);
        
        const sortedSchools = Object.entries(schoolMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
        const schoolLabels = sortedSchools.map(item => item[0]);
        const schoolValues = sortedSchools.map(item => item[1]);
    %>
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
        <div>
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight mb-1">របាយការណ៍វិភាគទិន្នន័យ</h1>
            <p class="text-gray-500 text-sm italic font-medium">គ្រប់គ្រងសិស្ស និងកត់វត្តមានកម្រិតអាជីព (V4.1)</p>
        </div>
        <div class="flex w-full md:w-auto items-center space-x-3">
            <div class="relative flex-grow md:w-64 group">
                <input type="text" id="searchInput" onkeyup="searchFunction()" placeholder="ស្វែងរកឈ្មោះ ឬលេខទូរស័ព្ទ..." 
                    class="w-full pl-10 pr-4 py-2.5 bg-white border border-gray-200 rounded-xl outline-none text-sm focus:ring-4 focus:ring-indigo-50 focus:border-indigo-500 transition-all">
                <svg class="w-4 h-4 absolute left-3.5 top-3 text-gray-400 group-focus-within:text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <button onclick="exportToExcel()" class="bg-emerald-500 hover:bg-emerald-600 text-white p-2.5 rounded-xl transition-all shadow-lg shadow-emerald-100 active:scale-95" title="ទាញយកជា Excel">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
        <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
            <p class="text-[10px] font-bold text-blue-500 uppercase mb-2 tracking-widest">សិស្សសរុប</p>
            <p class="text-3xl font-extrabold text-gray-900"><%= total %></p>
        </div>
        <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm border-l-4 border-l-emerald-500">
            <p class="text-[10px] font-bold text-emerald-500 uppercase mb-2 tracking-widest">មានវត្តមាន</p>
            <p class="text-3xl font-extrabold text-emerald-600"><%= checkedIn %></p>
        </div>
        <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm border-l-4 border-l-rose-500">
            <p class="text-[10px] font-bold text-rose-500 uppercase mb-2 tracking-widest">អវត្តមាន</p>
            <p class="text-3xl font-extrabold text-rose-600"><%= absent %></p>
        </div>
        <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
            <p class="text-[10px] font-bold text-indigo-500 uppercase mb-2 tracking-widest">អត្រាវត្តមាន</p>
            <p class="text-3xl font-extrabold text-gray-900"><%= rate %>%</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
        <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm">
            <h3 class="text-sm font-bold text-gray-800 mb-6 flex items-center gap-2">
                <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span> ស្ថិតិបែងចែកតាមខេត្ត/ក្រុង
            </h3>
            <div class="h-[320px] relative"><canvas id="provinceChart"></canvas></div>
        </div>
        <div class="bg-white p-8 rounded-[2.5rem] border border-gray-100 shadow-sm">
            <h3 class="text-sm font-bold text-gray-800 mb-6 flex items-center gap-2">
                <span class="w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></span> សាលាទាំង ១០ ដែលមានសិស្សច្រើនជាងគេ
            </h3>
            <div class="h-[320px] relative"><canvas id="schoolChart"></canvas></div>
        </div>
    </div>

    <div class="bg-white rounded-[2.5rem] border border-gray-100 overflow-hidden shadow-sm">
        <div class="overflow-x-auto table-container">
            <table id="studentTable" class="w-full text-left">
                <thead>
                    <tr class="text-[10px] font-bold text-gray-400 uppercase tracking-[0.2em] border-b border-gray-100 bg-gray-50/50">
                        <th class="px-8 py-6">ព័ត៌មានសិស្ស (KH / EN)</th>
                        <th class="px-6 py-6">ភេទ & ទំនាក់ទំនង</th>
                        <th class="px-6 py-6">វិទ្យាល័យ & ខេត្ត</th>
                        <th class="px-6 py-6 text-center">ស្ថានភាព</th>
                        <th class="px-8 py-6 text-right">សកម្មភាព</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                    <% if (students.length > 0) { %>
                        <% students.forEach(student => { 
                            const isChecked = checkedInIds.includes(student._id.toString());
                        %>
                            <tr class="hover:bg-indigo-50/30 transition-all duration-200 group">
                                <td class="px-8 py-5">
                                    <div class="font-bold text-gray-800"><%= student.name_kh %></div>
                                    <div class="text-[10px] text-gray-400 font-bold uppercase mt-0.5 italic"><%= student.name_en %></div>
                                </td>
                                <td class="px-6 py-5">
                                    <div class="text-[10px] font-black text-indigo-400 uppercase mb-1"><%= student.gender %></div>
                                    <div class="text-sm text-gray-600 font-medium"><%= student.phone %></div>
                                </td>
                                <td class="px-6 py-5">
                                    <div class="text-sm text-gray-700 font-bold"><%= student.high_school %></div>
                                    <div class="text-[10px] text-gray-400 uppercase font-medium"><%= student.province %></div>
                                </td>
                                <td class="px-6 py-5 text-center">
                                    <% if (isChecked) { %>
                                        <span class="inline-flex items-center px-4 py-1.5 rounded-full bg-emerald-100 text-emerald-600 text-[9px] font-black uppercase">វត្តមានរួច</span>
                                    <% } else { %>
                                        <span class="inline-flex items-center px-4 py-1.5 rounded-full bg-rose-50 text-rose-500 text-[9px] font-black uppercase animate-pulse border border-rose-100">អវត្តមាន</span>
                                    <% } %>
                                </td>
                                <td class="px-8 py-5 text-right flex justify-end items-center gap-2">
                                    <% if (!isChecked) { %>
                                        <form action="/admin/check-in/<%= student._id %>" method="POST">
                                            <button type="submit" class="bg-indigo-600 text-white text-[9px] px-4 py-2 rounded-xl font-black hover:bg-indigo-700 transition-all active:scale-90">MARK PRESENT</button>
                                        </form>
                                    <% } else { %>
                                        <span class="text-[10px] text-gray-400 font-bold italic flex items-center gap-1 opacity-60">
                                            <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                            Verified
                                        </span>
                                    <% } %>
                                    <button onclick="confirmDelete('<%= student._id %>', '<%= student.name_kh %>')" class="p-2 text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all" title="លុបសិស្ស">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </td>
                            </tr>
                        <% }) %>
                    <% } %>
                </tbody>
            </table>
        </div>
        <div class="p-8 bg-gray-50/30 border-t border-gray-100 flex justify-between items-center">
            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-[0.3em]">Total: <%= students.length %> Records Found</p>
            <p class="text-[9px] text-gray-300 italic">Evolution System v4.1 • <%= new Date().toLocaleDateString() %></p>
        </div>
    </div>
</main>

<script>
    // --- មុខងារ Delete ជាមួយ SweetAlert2 ---
    async function confirmDelete(studentId, studentName) {
        const { value: confirmed } = await Swal.fire({
            title: 'តើបងប្រាកដទេ?',
            text: `បងចង់លុបសិស្សឈ្មោះ "${studentName}" ចេញមែនទេ? ទិន្នន័យនឹងបាត់បង់!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#e11d48',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'យល់ព្រមលុប',
            cancelButtonText: 'បោះបង់'
        });

        if (confirmed) {
            try {
                const response = await fetch(`/admin/delete-student/${studentId}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    Swal.fire('លុបរួចរាល់!', 'ទិន្នន័យសិស្សត្រូវបានលុប។', 'success').then(() => location.reload());
                } else {
                    Swal.fire('បរាជ័យ', result.message || 'មិនអាចលុបបានទេ!', 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'មានបញ្ហាបច្ចេកទេស!', 'error');
            }
        }
    }

    // --- កូដសម្រាប់ Chart.js ---
    Chart.defaults.font.family = "'Kantumruy Pro', sans-serif";
    const ctxProv = document.getElementById('provinceChart').getContext('2d');
    new Chart(ctxProv, {
        type: 'doughnut',
        data: {
            labels: <%- JSON.stringify(provinceLabels) %>,
            datasets: [{
                data: <%- JSON.stringify(provinceValues) %>,
                backgroundColor: ['#4F46E5', '#3B82F6', '#6366F1', '#818CF8', '#A5B4FC'],
                borderWidth: 4,
                borderColor: '#ffffff'
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, cutout: '65%' }
    });

    const ctxSchool = document.getElementById('schoolChart').getContext('2d');
    new Chart(ctxSchool, {
        type: 'bar',
        data: {
            labels: <%- JSON.stringify(schoolLabels) %>,
            datasets: [{ label: 'ចំនួនសិស្ស', data: <%- JSON.stringify(schoolValues) %>, backgroundColor: '#4F46E5', borderRadius: 12 }]
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });

    function searchFunction() {
        let input = document.getElementById("searchInput");
        let filter = input.value.toUpperCase();
        let tr = document.getElementById("studentTable").getElementsByTagName("tr");
        for (let i = 1; i < tr.length; i++) {
            let text = tr[i].textContent || tr[i].innerText;
            tr[i].style.display = text.toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    }

    function exportToExcel() {
        let wb = XLSX.utils.table_to_book(document.getElementById("studentTable"), { sheet: "Attendance" });
        XLSX.writeFile(wb, "Student_Analytical_Report.xlsx");
    }
</script>

<%- include('partials/footer') %>