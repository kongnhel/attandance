<%- include('partials/header') %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<main class="max-w-7xl mx-auto p-4 md:p-10 pb-24">
    <% 
        // 1. üî• ·ûè·ûò·üí·ûö·üÄ·ûî·ûü·û∑·ûü·üí·ûü·ûè·û∂·ûò·ûà·üí·ûò·üÑ·üá·ûü·û∂·ûõ·û∂
        students.sort((a, b) => {
            const schoolA = a.high_school || "zzzz";
            const schoolB = b.high_school || "zzzz";
            return schoolA.localeCompare(schoolB, 'km');
        });

        let totalStudents = students.length;
        
        const provinceMap = {};
        const schoolMap = {};
        
        students.forEach(s => {
            // Check undefined for old data
            const pName = s.province && s.province !== "undefined" ? s.province : "·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûÄ·üÜ·ûé·ûè·üã";
            const sName = s.high_school || "·ûï·üí·ûü·üÅ·ûÑ·üó";
            
            provinceMap[pName] = (provinceMap[pName] || 0) + 1;
            schoolMap[sName] = (schoolMap[sName] || 0) + 1;

            s.province = pName;
        });

        const uniqueSchools = Object.keys(schoolMap).sort();
        const uniqueProvinces = Object.keys(provinceMap).sort();

        const provinceLabels = Object.keys(provinceMap);
        const provinceValues = Object.values(provinceMap);
        const sortedSchools = Object.entries(schoolMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
        const schoolLabels = sortedSchools.map(item => item[0]);
        const schoolValues = sortedSchools.map(item => item[1]);

        let totalSchools = Object.keys(schoolMap).length;
        let totalProvinces = Object.keys(provinceMap).length;
    %>

    <div style="display: none;">
        <table id="studentTable">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Name KH</th>
                    <th>Name EN</th>
                    <th>Gender</th>
                    <th>Phone</th>
                    <th>High School</th>
                    <th>Province</th>
                </tr>
            </thead>
            <tbody>
                <% students.forEach((s, index) => { %>
                    <tr>
                        <td><%= index + 1 %></td>
                        <td><%= s.name_kh || "" %></td>
                        <td><%= s.name_en || "" %></td>
                        <td><%= s.gender || "" %></td>
                        <td><%= s.phone || "" %></td>
                        <td><%= s.high_school || "" %></td>
                        <td><%= s.province || "" %></td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
        <div>
            <h1 class="text-2xl md:text-3xl font-extrabold text-slate-800 tracking-tight mb-1">
                <span class="text-indigo-600">Student</span> Data Center
            </h1>
            <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase tracking-widest">
                ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûü·û∑·ûü·üí·ûü ·ûì·û∑·ûÑ·ûü·üí·ûê·û∑·ûè·û∑·ûú·û∑·ûë·üí·ûô·û∂·ûõ·üê·ûô
            </p>
        </div>
        
        <button onclick="exportToExcel()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-5 py-3 rounded-2xl transition-all shadow-lg shadow-emerald-100 active:scale-95 group flex items-center gap-2 font-bold text-sm">
            <svg class="w-5 h-5 group-hover:animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            Export Excel
        </button>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 md:gap-6 mb-10">
        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden">
            <div class="absolute right-0 top-0 w-24 h-24 bg-indigo-50 rounded-full -mr-8 -mt-8 opacity-50"></div>
            <p class="text-[10px] font-black text-indigo-400 uppercase mb-1 tracking-[0.2em] relative z-10">Total Students</p>
            <h3 class="text-3xl md:text-4xl font-black text-slate-800 relative z-10"><%= totalStudents %></h3>
        </div>
        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden">
            <div class="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-full -mr-8 -mt-8 opacity-50"></div>
            <p class="text-[10px] font-black text-blue-400 uppercase mb-1 tracking-[0.2em] relative z-10">Total Schools</p>
            <h3 class="text-3xl md:text-4xl font-black text-slate-800 relative z-10"><%= totalSchools %></h3>
        </div>
        <div class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm relative overflow-hidden">
            <div class="absolute right-0 top-0 w-24 h-24 bg-emerald-50 rounded-full -mr-8 -mt-8 opacity-50"></div>
            <p class="text-[10px] font-black text-emerald-400 uppercase mb-1 tracking-[0.2em] relative z-10">Provinces</p>
            <h3 class="text-3xl md:text-4xl font-black text-slate-800 relative z-10"><%= totalProvinces %></h3>
        </div>
    </div>

    <div class="bg-white p-4 md:p-6 rounded-[2rem] border border-slate-100 shadow-sm mb-8 flex flex-col md:flex-row gap-4">
        <div class="relative flex-grow group">
            <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="üîç ·ûü·üí·ûú·üÇ·ûÑ·ûö·ûÄ·ûà·üí·ûò·üÑ·üá·ûü·û∑·ûü·üí·ûü..." 
                class="w-full pl-11 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold text-slate-600 focus:ring-2 focus:ring-indigo-100 focus:border-indigo-400 transition-all">
            <svg class="w-5 h-5 absolute left-3.5 top-3 text-slate-400 group-focus-within:text-indigo-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
        </div>

        <div class="relative md:w-64">
            <select id="schoolFilter" onchange="applyFilters()" class="w-full pl-4 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold text-slate-600 focus:ring-2 focus:ring-indigo-100 focus:border-indigo-400 appearance-none cursor-pointer">
                <option value="">üè´ ·ûü·û∂·ûõ·û∂·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã (All Schools)</option>
                <% uniqueSchools.forEach(school => { %>
                    <option value="<%= school %>"><%= school %></option>
                <% }) %>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-slate-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
        </div>

        <div class="relative md:w-48">
            <select id="provinceFilter" onchange="applyFilters()" class="w-full pl-4 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none text-sm font-bold text-slate-600 focus:ring-2 focus:ring-indigo-100 focus:border-indigo-400 appearance-none cursor-pointer">
                <option value="">üìç ·ûÅ·üÅ·ûè·üí·ûè·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã</option>
                <% uniqueProvinces.forEach(province => { %>
                    <option value="<%= province %>"><%= province %></option>
                <% }) %>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-slate-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden animate-fade-in">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse whitespace-nowrap" id="mainTable">
                <thead class="bg-slate-50/80">
                    <tr class="text-[10px] md:text-xs font-black text-slate-400 uppercase tracking-widest border-b border-slate-100">
                        <th class="px-6 py-4 w-12">#</th>
                        <th class="px-6 py-4">Student Name</th>
                        <th class="px-6 py-4">Gender & Phone</th>
                        <th class="px-6 py-4">High School</th>
                        <th class="px-6 py-4">Province</th>
                        <th class="px-6 py-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-50" id="tableBody">
                    <% students.forEach((s, index) => { %>
                        <tr class="hover:bg-indigo-50/30 transition-colors group student-row" 
                            data-name="<%= s.name_kh.toLowerCase() %> <%= (s.name_en || '').toLowerCase() %>" 
                            data-school="<%= s.high_school %>" 
                            data-province="<%= s.province %>">
                            
                            <td class="px-6 py-4 text-slate-400 font-bold text-xs index-cell"><%= index + 1 %></td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-9 h-9 rounded-full bg-slate-100 flex items-center justify-center text-xs font-black text-slate-500 group-hover:bg-indigo-500 group-hover:text-white transition-colors">
                                        <%= (s.name_en && s.name_en.length > 0) ? s.name_en.charAt(0).toUpperCase() : '?' %>
                                    </div>
                                    <div>
                                        <div class="font-bold text-slate-700 text-sm"><%= s.name_kh %></div>
                                        <div class="text-[10px] text-slate-400 font-bold uppercase"><%= s.name_en || "" %></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-slate-600 font-mono"><%= s.phone %></span>
                                    <span class="text-[10px] text-slate-400 font-bold"><%= s.gender %></span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-lg">
                                    üè´ <%= s.high_school %>
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <% if (s.province === '·ûò·û∑·ûì·ûë·û∂·ûì·üã·ûÄ·üÜ·ûé·ûè·üã') { %>
                                    <span class="text-xs font-bold text-rose-400 bg-rose-50 px-2 py-1 rounded-lg">‚ùì <%= s.province %></span>
                                <% } else { %>
                                    <span class="text-xs font-bold text-slate-500">üìç <%= s.province %></span>
                                <% } %>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <button onclick="confirmDelete('<%= s._id %>', '<%= s.name_kh %>')" class="p-2 text-rose-400 hover:bg-rose-500 hover:text-white rounded-xl transition-all shadow-sm" title="Delete">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
        
        <div class="px-6 py-4 border-t border-slate-100 flex items-center justify-between bg-slate-50/50" id="paginationControls">
            <span class="text-xs font-bold text-slate-400" id="showingInfo">Showing 0 of 0</span>
            <div class="flex gap-2">
                <button onclick="prevPage()" id="prevBtn" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition-all disabled:opacity-50">Previous</button>
                <button onclick="nextPage()" id="nextBtn" class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition-all disabled:opacity-50">Next</button>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8 mt-12">
        <div class="bg-white p-6 md:p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
            <h3 class="text-xs md:text-sm font-bold text-slate-700 mb-6 flex items-center gap-2">
                <span class="w-3 h-3 bg-blue-500 rounded-full"></span> ·ûÄ·û∂·ûö·ûî·üÇ·ûÑ·ûÖ·üÇ·ûÄ·ûè·û∂·ûò·ûÅ·üÅ·ûè·üí·ûè
            </h3>
            <div class="h-[250px] md:h-[300px] relative"><canvas id="provinceChart"></canvas></div>
        </div>
        <div class="bg-white p-6 md:p-8 rounded-[2.5rem] border border-slate-100 shadow-sm">
            <h3 class="text-xs md:text-sm font-bold text-slate-700 mb-6 flex items-center gap-2">
                <span class="w-3 h-3 bg-indigo-500 rounded-full"></span> ·ûü·û∂·ûõ·û∂·ûä·üÇ·ûõ·ûò·û∂·ûì·ûü·û∑·ûü·üí·ûü·ûÖ·üí·ûö·ûæ·ûì·ûá·û∂·ûÑ·ûÇ·üÅ
            </h3>
            <div class="h-[250px] md:h-[300px] relative"><canvas id="schoolChart"></canvas></div>
        </div>
    </div>

</main>

<script>
    // --- üî¢ Pagination & Filter Logic ---
    const itemsPerPage = 25;
    let currentPage = 1;
    let filteredRows = [];

    document.addEventListener("DOMContentLoaded", () => {
        const rows = Array.from(document.querySelectorAll('.student-row'));
        filteredRows = rows; 
        updateTable();
    });

    function applyFilters() {
        const searchText = document.getElementById('searchInput').value.toLowerCase();
        const schoolFilter = document.getElementById('schoolFilter').value;
        const provinceFilter = document.getElementById('provinceFilter').value;
        const allRows = Array.from(document.querySelectorAll('.student-row'));

        filteredRows = allRows.filter(row => {
            const name = row.getAttribute('data-name');
            const school = row.getAttribute('data-school');
            const province = row.getAttribute('data-province');

            const matchesSearch = name.includes(searchText);
            const matchesSchool = schoolFilter === "" || school === schoolFilter;
            const matchesProvince = provinceFilter === "" || province === provinceFilter;

            return matchesSearch && matchesSchool && matchesProvince;
        });

        currentPage = 1;
        updateTable();
    }

    function updateTable() {
        const allRows = Array.from(document.querySelectorAll('.student-row'));
        allRows.forEach(row => row.style.display = 'none'); // Hide all

        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageRows = filteredRows.slice(start, end);

        pageRows.forEach((row, index) => {
            row.style.display = ''; // Show relevant
            row.querySelector('.index-cell').textContent = start + index + 1;
        });

        const total = filteredRows.length;
        const showingStart = total === 0 ? 0 : start + 1;
        const showingEnd = Math.min(end, total);
        document.getElementById('showingInfo').textContent = `Showing ${showingStart}-${showingEnd} of ${total} students`;

        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = end >= total;
    }

    function nextPage() {
        if ((currentPage * itemsPerPage) < filteredRows.length) {
            currentPage++;
            updateTable();
        }
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            updateTable();
        }
    }

    // --- üì• EXPORT EXCEL (Old Logic - ·ûî·üí·ûö·ûæ Hidden Table) ---
    // ·ûò·ûª·ûÅ·ûÑ·û∂·ûö·ûì·üÅ·üá Export ·ûè·û∂·ûò·ûè·û∂·ûö·û∂·ûÑ·ûü·ûò·üí·ûÑ·û∂·ûè·üã id="studentTable" ·ûä·üÇ·ûõ·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûü·û∑·ûü·üí·ûü·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã
    function exportToExcel() {
        let table = document.getElementById("studentTable");
        let wb = XLSX.utils.table_to_book(table, { sheet: "Students" });
        XLSX.writeFile(wb, "Student_Data_List.xlsx");
    }

    // --- üóëÔ∏è Delete ---
    async function confirmDelete(studentId, studentName) {
        const result = await Swal.fire({
            title: '·ûõ·ûª·ûî·ûü·û∑·ûü·üí·ûü?',
            text: `·ûè·ûæ·û¢·üí·ûì·ûÄ·ûÖ·ûÑ·üã·ûõ·ûª·ûî "${studentName}" ·ûÖ·üÅ·ûâ·ûò·üÇ·ûì·ûë·üÅ?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f43f5e',
            cancelButtonColor: '#94a3b8',
            confirmButtonText: 'Yes, Delete',
            customClass: { popup: 'rounded-[2rem]' }
        });

        if (result.isConfirmed) {
            try {
                const response = await fetch(`/admin/delete-student/${studentId}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    Swal.fire({ title: '·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã!', icon: 'success', timer: 1000, showConfirmButton: false }).then(() => location.reload());
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            } catch (error) {
                Swal.fire('Error', 'Server Error', 'error');
            }
        }
    }

    // --- üìä Chart ---
    Chart.defaults.font.family = "'Kantumruy Pro', sans-serif";
    new Chart(document.getElementById('provinceChart'), {
        type: 'doughnut',
        data: {
            labels: <%- JSON.stringify(provinceLabels) %>,
            datasets: [{
                data: <%- JSON.stringify(provinceValues) %>,
                backgroundColor: ['#6366F1', '#3B82F6', '#818CF8', '#A5B4FC', '#C7D2FE'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } } }
    });

    new Chart(document.getElementById('schoolChart'), {
        type: 'bar',
        data: {
            labels: <%- JSON.stringify(schoolLabels) %>,
            datasets: [{ label: 'Students', data: <%- JSON.stringify(schoolValues) %>, backgroundColor: '#4F46E5', borderRadius: 8, barThickness: 20 }]
        },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { display: false } } }, plugins: { legend: { display: false } } }
    });
</script>

<style>
    .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; transform: translateY(10px); }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
</style>

<%- include('partials/footer') %>